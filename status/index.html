<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>สถานะการส่ง P4P</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@5" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai+Looped:wght@100..900&display=swap"
        rel="stylesheet">
    <script src="https://kit.fontawesome.com/9b1f6eb9b1.js" crossorigin="anonymous"></script>
    <style>
        body {
            font-family: "Noto Sans Thai Looped", sans-serif;
        }

        #header,
        #content,
        #pending,
        #sent,
        #searchable {
            display: none;
        }
    </style>
</head>

<body>
    <div id="header" class="navbar bg-base-200 shadow-md sticky flex flex-col align-center top-0 z-10 mb-8 pt-0">
        <div class="flex items-center w-screen">
            <div id="header_display"
                class="bg-base-300 w-1/2 p-2 pl-12 text-left text-lg font-semibold skeleton skeleton-text">
                เดือน..
            </div>
            <div id="header_count" class="bg-base-200 w-1/2 p-2 pr-4 text-right text-md skeleton skeleton-text">
                รวบรวมข้อมูล..
            </div>
        </div>
        <div class="grid grid-cols-1 justify-items-center w-screen p-4">
            <label class="input">
                <svg class="h-[1em] opacity-50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <g stroke-linejoin="round" stroke-linecap="round" stroke-width="2.5" fill="none"
                        stroke="currentColor">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.3-4.3"></path>
                    </g>
                </svg>
                <input id="header_search" type="search" required placeholder="พิมพ์เพื่อค้นหา.." autocomplete="off"
                    disabled />
            </label>
            <div id="header_note" class="text-xs text-base-300 mt-1">พิมพ์เว้นวรรคเพื่อดูรายชื่อทั้งหมดเรียงตามกลุ่มงาน
            </div>
            <div class="grid grid-cols-2 justify-items-center w-full mt-4">
                <div class="pl-6">
                    <input id="byname_input" type="radio" class="radio radio-sm mr-2" disabled />
                    <label id="byname_label" for="byname_input" class="text-base-300">ชื่อแพทย์</label>
                </div>
                <div class="pr-6">
                    <input id="bydep_input" type="radio" class="radio radio-sm mr-2" disabled />
                    <label id="bydep_label" for="bydep_input" class="text-base-300">ชื่อกลุ่มงาน</label>
                </div>
            </div>
        </div>
    </div>
    <div id="content" class="grid grid-cols-1 justify-items-center mx-4">
        <div id="load" class="loading loading-dots loading-lg"></div>
        <div id="pending" class="collapse collapse-arrow border bg-base-300 mb-4">
            <input type="checkbox" />
            <div class="collapse-title text-lg font-semibold">รายชื่อผู้ที่ยังไม่ได้ส่ง</div>
            <div class="collapse-content">
                <div id="tablebox" class="overflow-x-auto rounded-box border bg-base-100 m-2">
                    <table class="table">
                        <tbody id="tbody_pending"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="sent" class="collapse collapse-arrow border bg-base-300">
            <input type="checkbox" />
            <div class="collapse-title text-lg font-semibold">รายชื่อผู้ที่ส่งแล้ว</div>
            <div class="collapse-content">
                <div id="tablebox" class="overflow-x-auto rounded-box border bg-base-100 m-2">
                    <table class="table">
                        <tbody id="tbody_sent"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="searchable" class="w-full overflow-x-auto rounded-box border bg-amber-50 mx-4">
            <table class="table">
                <tbody id="tbody_searchable"></tbody>
            </table>
        </div>
    </div>
    <button type="button" id="backtotop"
        class="z-10 fixed bottom-4 right-4 rounded-full shadow-md focus:shadow-lg active:shadow-lg transition duration-150 ease-in-out hidden">
        <svg class="size-10" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
            <path fill="#545454"
                d="M320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C178.6 64 64 178.6 64 320C64 461.4 178.6 576 320 576zM441 335C450.4 344.4 450.4 359.6 441 368.9C431.6 378.2 416.4 378.3 407.1 368.9L320.1 281.9L233.1 368.9C223.7 378.3 208.5 378.3 199.2 368.9C189.9 359.5 189.8 344.3 199.2 335L303 231C312.4 221.6 327.6 221.6 336.9 231L441 335z" />
        </svg>
    </button>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.13.2/dist/axios.min.js"></script>
    <script>
        const queryString = decodeURIComponent(window.location.search).replace("?liff.state=", "");
        const par_date = new URLSearchParams(queryString).get("date")
        const par_color = new URLSearchParams(queryString).get("color")
        const header = document.getElementById("header")
        const header_count = document.getElementById("header_count")
        const header_display = document.getElementById("header_display")
        const header_search = document.getElementById("header_search")
        const header_note = document.getElementById("header_note")
        const byname_input = document.getElementById("byname_input")
        const byname_label = document.getElementById("byname_label")
        const bydep_input = document.getElementById("bydep_input")
        const bydep_label = document.getElementById("bydep_label")
        const content = document.getElementById("content")
        const load = document.getElementById("load")
        const pending = document.getElementById("pending")
        const sent = document.getElementById("sent")
        const searchable = document.getElementById("searchable")
        const tbody_pending = document.getElementById("tbody_pending")
        const tbody_sent = document.getElementById("tbody_sent")
        const tbody_searchable = document.getElementById("tbody_searchable")
        const backtotop = document.getElementById("backtotop");
        const dep_array = ["กุมารเวชกรรม", "จักษุวิทยา", "จิตเวชและยาเสพติด", "เทคนิคการแพทย์และพยาธิวิทยาคลินิก", "นิติเวช", "ผู้ป่วยนอก", "พยาธิวิทยากายวิภาค", "รังสีวิทยา", "วิสัญญีวิทยา", "เวชกรรมฟื้นฟู", "เวชศาสตร์ฉุกเฉิน", "ศัลยกรรม", "ศัลยกรรมออร์โธปิดิกส์", "สูติ-นรีเวชกรรม", "โสต ศอ นาสิก", "อาชีวเวชกรรม", "อายุรกรรม", "INTERN"]
        const url = "https://script.google.com/macros/s/AKfycbypT_Qzc0d_eZ5v1yH4e46RK2NARXOplqZdsNUOfBgPRtYywrXA1mYzCYDflVJVRO4zpA/exec?date="
        let count_true = 0
        let arr = []
        const displaying = (param) => {
            let month_array = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"]
            let year = param.slice(0, 4)
            let month = parseInt(param.slice(5))
            return month_array[month - 1] + " " + year
        }
        const scrolling = () => {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                backtotop.classList.remove("hidden")
            } else {
                backtotop.classList.add("hidden")
            }
        }
        const topping = () => {
            window.scrollTo({
                top: 0,
                behavior: "smooth"
            })
        }
        const fulling = () => {
            for (i = 0; i < dep_array.length; i++) {
                let count = 0
                for (j = 0; j < arr.length; j++) {
                    if (arr[j][2] === dep_array[i]) {
                        count += 1
                        if (count < 2) {
                            let tr_header = document.createElement("tr")
                            let td = document.createElement("td")
                            td.classList.add("bg-amber-900", "text-white", "text-center", "text-lg", "font-semibold")
                            td.colSpan = 2
                            if (dep_array[i] === "INTERN") {
                                td.innerText = dep_array[i]
                            } else {
                                td.innerText = "กลุ่มงาน" + dep_array[i]
                            }
                            tbody_searchable.appendChild(tr_header).appendChild(td)
                        }
                        let tr_content = document.createElement("tr")
                        let td_name = document.createElement("td")
                        td_name.classList.add("text-lg")
                        td_name.innerText = arr[j][1] + "  (" + arr[j][0] + ")"
                        let td_status = document.createElement("td")
                        let icon = document.createElement("i")
                        if (arr[j][3]) {
                            icon.classList.add("fa-solid", "fa-check")
                            count_true += 1
                        } else {
                            icon.style.color = "red"
                            icon.classList.add("fa-solid", "fa-xmark")
                            td_name.classList.add("text-red-700")
                        }
                        td_status.appendChild(icon)
                        tr_content.appendChild(td_name)
                        tr_content.appendChild(td_status)
                        tbody_searchable.appendChild(tr_content)
                    }
                }
            }
        }
        window.addEventListener("scroll", scrolling)
        backtotop.addEventListener("click", topping)
        byname_input.addEventListener("change", function () {
            pending.style.display = "grid"
            sent.style.display = "grid"
            searchable.style.display = "none"
            if (this.checked) {
                bydep_input.checked = false
                header_search.disabled = false
                header_search.value = ""
            } else {
                bydep_input.checked = true
            }
        })
        bydep_input.addEventListener("change", function () {
            pending.style.display = "grid"
            sent.style.display = "grid"
            searchable.style.display = "none"
            if (this.checked) {
                byname_input.checked = false
                header_search.disabled = false
                header_search.value = ""
            } else {
                byname_input.checked = true
            }
        })
        header_search.addEventListener("focus", function () {
            pending.style.display = "grid"
            sent.style.display = "grid"
            searchable.style.display = "none"
            this.value = ""
        })
        header_search.addEventListener("input", function () {
            while (tbody_searchable.firstChild) {
                tbody_searchable.removeChild(tbody_searchable.lastChild)
            }
            if (this.value !== "") {
                pending.style.display = "none"
                sent.style.display = "none"
                searchable.style.display = "grid"
                if (/^[ ]+$/.test(this.value)) {
                    fulling()
                } else {
                    if (byname_input.checked) {
                        let data = arr.filter((elem) => elem[1].includes(this.value.trim().toLowerCase()))
                        if (data.length !== 0) {
                            for (i = 0; i < dep_array.length; i++) {
                                let count = 0
                                for (j = 0; j < data.length; j++) {
                                    if (data[j][2] === dep_array[i]) {
                                        count += 1
                                        if (count < 2) {
                                            let tr_header = document.createElement("tr")
                                            let td = document.createElement("td")
                                            td.classList.add("bg-amber-900", "text-white", "text-center", "text-lg", "font-semibold")
                                            td.colSpan = 2
                                            if (dep_array[i] === "INTERN") {
                                                td.innerText = dep_array[i]
                                            } else {
                                                td.innerText = "กลุ่มงาน" + dep_array[i]
                                            }
                                            tbody_searchable.appendChild(tr_header).appendChild(td)
                                        }
                                        let tr_content = document.createElement("tr")
                                        let td_name = document.createElement("td")
                                        td_name.classList.add("text-lg")
                                        td_name.innerText = data[j][1] + "  (" + data[j][0] + ")"
                                        let td_status = document.createElement("td")
                                        let icon = document.createElement("i")
                                        if (data[j][3]) {
                                            icon.classList.add("fa-solid", "fa-check")
                                            count_true += 1
                                        } else {
                                            icon.style.color = "red"
                                            icon.classList.add("fa-solid", "fa-xmark")
                                            td_name.classList.add("text-red-700")
                                        }
                                        td_status.appendChild(icon)
                                        tr_content.appendChild(td_name)
                                        tr_content.appendChild(td_status)
                                        tbody_searchable.appendChild(tr_content)
                                    }
                                }
                            }
                        } else {
                            searchable.style.display = "none"
                        }
                    } else if (bydep_input.checked) {
                        let data = arr.filter((elem) => elem[2].includes(this.value.trim().toLowerCase()))
                        if (data.length !== 0) {
                            let count = 0
                            for (i = 0; i < data.length; i++) {
                                count += 1
                                if (count < 2) {
                                    let tr_header = document.createElement("tr")
                                    let td = document.createElement("td")
                                    td.classList.add("bg-amber-900", "text-white", "text-center", "text-lg", "font-semibold")
                                    td.colSpan = 2
                                    if (data[i][2] === "INTERN") {
                                        td.innerText = data[i][2]
                                    } else {
                                        td.innerText = "กลุ่มงาน" + data[i][2]
                                    }
                                    tbody_searchable.appendChild(tr_header).appendChild(td)
                                }
                                let tr_content = document.createElement("tr")
                                let td_name = document.createElement("td")
                                td_name.classList.add("text-lg")
                                td_name.innerText = data[i][1] + "  (" + data[i][0] + ")"
                                let td_status = document.createElement("td")
                                let icon = document.createElement("i")
                                if (data[i][3]) {
                                    icon.classList.add("fa-solid", "fa-check")
                                    count_true += 1
                                } else {
                                    icon.style.color = "red"
                                    icon.classList.add("fa-solid", "fa-xmark")
                                    td_name.classList.add("text-red-700")
                                }
                                td_status.appendChild(icon)
                                tr_content.appendChild(td_name)
                                tr_content.appendChild(td_status)
                                tbody_searchable.appendChild(tr_content)
                            }
                        } else {
                            searchable.style.display = "none"
                        }
                    }
                }
            } else {
                pending.style.display = "grid"
                sent.style.display = "grid"
                searchable.style.display = "none"
            }
        })
        const longInLIFF = async () => {
            if (window.innerWidth < 481) {
                await liff.init({
                    liffId: "2008561527-a0xP1XmY"
                })
                if (liff.isInClient()) {
                    if (liff.isLoggedIn()) {
                        header.style.display = "flex"
                        content.style.display = "grid"
                        axios.get(url + par_date)
                            .then(response => {
                                header_display.innerText = displaying(par_date)
                                header_display.classList.remove("skeleton", "skeleton-text", "bg-base-300")
                                header_display.classList.add(par_color)
                                header_count.classList.remove("skeleton", "skeleton-text")
                                header_note.classList.remove("text-base-200")
                                header_note.classList.add("text-black")
                                byname_input.disabled = false
                                byname_label.classList.remove("text-base-300")
                                bydep_input.disabled = false
                                bydep_label.classList.remove("text-base-300")
                                load.style.display = "none"
                                pending.style.display = "grid"
                                pending.classList.remove("bg-base-300")
                                pending.classList.add(par_color)
                                sent.style.display = "grid"
                                const data = response.data
                                for (i = 0; i < data.length; i++) {
                                    arr[i] = data[i]
                                    let tr = document.createElement("tr")
                                    let td_name = document.createElement("td")
                                    let div = document.createElement("div")
                                    div.classList.add("grid", "grid-cols-1")
                                    let p1 = document.createElement("p")
                                    p1.innerText = data[i][1]
                                    p1.classList.add("text-lg")
                                    let p2 = document.createElement("p")
                                    p2.innerText = data[i][0] + " | " + data[i][2]
                                    p2.classList.add("text-sm", "text-gray-600")
                                    div.appendChild(p1)
                                    div.appendChild(p2)
                                    tr.appendChild(td_name).appendChild(div)
                                    let td_status = document.createElement("td")
                                    let icon = document.createElement("i")
                                    if (data[i][3]) {
                                        icon.classList.add("fa-solid", "fa-check")
                                        td_status.appendChild(icon)
                                        tbody_sent.appendChild(tr).appendChild(td_status)
                                        count_true += 1
                                    } else {
                                        icon.classList.add("fa-solid", "fa-xmark")
                                        td_status.appendChild(icon)
                                        tbody_pending.appendChild(tr).appendChild(td_status)
                                    }
                                }
                                header_count.innerText = "(ส่ง " + count_true + " จาก " + data.length + " ราย)"
                            })
                            .catch((error) => console.error(error))
                    } else {
                        liff.login({ redirectUri: "https://sakhonmso.pongpoti.deno.net/status?date=" + par_date })
                    }
                } else {
                    window.location.replace("https://sakhonmso.pongpoti.deno.net/external")
                }
            } else {
                window.location.replace("https://sakhonmso.pongpoti.deno.net/external")
            }
        }
        longInLIFF()
    </script>
</body>

</html>